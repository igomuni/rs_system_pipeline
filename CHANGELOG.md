# Changelog

## [1.0.3] - 2025-10-04

### 追加

#### 空データフィルタリング機能
- **予算レコードの最適化**: 実データのない年度を自動除外
  - `table_builder.py`: `build_budget_summary_table()` に空データチェックロジックを追加
  - 全フィールド（当初予算、補正予算、繰越、執行額、執行率、予算合計）を検証
  - NaNまたは0のみのレコードを除外

### 改善

#### ファイルサイズの大幅削減
- **予算ファイルサイズ**: 約70%削減
  - 2020年度: 20MB → 6.0MB（59,895レコード → 17,046レコード）
  - 2015-2020年度: 各6.0MB（4年分のデータのみ保持）
  - 2021-2023年度: 各8.0MB（5年分のデータのみ保持）

#### レコード数の最適化
- **総レコード数**: 1,327,926件 → 961,474件（27.6%削減）
- **予算・執行レコード**: 534,477件 → 188,472件（64.7%削減）
- 各年度ファイルは実データのある年度のみを含む（4〜5年分）

#### ドキュメント更新
- **README.md**:
  - 出力データ統計を更新（空データフィルタ適用後の数値）
  - ファイルサイズ列を追加
  - 注記を追加（予算レコード数の説明）
- **DATA_QUALITY_REPORT.md**:
  - 生成日時を更新
  - 年度別基本統計（予算レコード数、ファイルサイズ）を更新
  - 空データフィルタ適用済の注記を追加
- **.gitignore**: 品質レポートの管理対象を整理
  - 統合レポート（DATA_QUALITY_REPORT.md）のみ含める
  - 年度別レポートは除外

## [1.0.2] - 2025-10-04

### 追加

#### データ品質確認ツールの整備
- **新規フォルダ**: `data_quality/` を作成し、品質確認スクリプトを集約
- **年度別品質レポート生成**: `generate_quality_report.py` を追加
  - 全年度（2014-2023）の詳細レポートを自動生成
  - **統合レポート**: `DATA_QUALITY_REPORT.md` を自動生成
    - 年度別基本統計一覧
    - 予算・執行データ一覧
    - 支出先データ一覧
    - 検出された品質問題一覧（**事業名・府省庁を含む**）
    - 推奨事項
  - **年度別レポート**: 各年度の詳細レポート（`reports/quality_report_YYYY.md`）
  - 異常値の自動検出（100兆円以上の予算、50兆円以上の支出など）
- **支出先データサマリー**: `expenditure_summary.py` を追加
  - 年度別の支出先件数、支出額合計、平均支出額を表示
  - 2016年度の支出データに単位異常を検出（約115兆円）

#### データ品質レポートの更新
- **単位の修正**: 「億円」→「10億円」に統一
  - `summary_report.py`: 換算式を修正（÷1,000 → ÷10,000）
  - `DATA_QUALITY_REPORT.md`: 全テーブルの単位表記を修正
- **支出先データサマリー追加**: DATA_QUALITY_REPORT.md に年度別支出先統計テーブルを追加
- **2016年度の問題追記**: 支出先データの単位異常（115兆円）を文書化

### 改善

- **README.md**: データ品質確認セクションを追加
  - 品質レポート生成方法の説明
  - 既知のデータ品質問題のサマリー
  - DATA_QUALITY_REPORT.md のパスを `data_quality/` に更新
- **data_quality/README.md**: 詳細な使用方法とレポート例を追加
- **プロジェクト構造図**: `data_quality/` フォルダを追加
- **.gitignore**: 品質レポート（.md）を Git 管理対象に含めるよう設定
- **DATA_QUALITY_REPORT.md**: `data_quality/` フォルダに移動

## [1.0.1] - 2025-10-03

### 修正

#### 2020年度予算データ欠損の修正
- **問題**: 2020年度の予算年度レコードが0件だった
- **原因**: 正規表現パターンが「-2年度-」形式（1桁の年度番号）をキャプチャできていなかった
- **修正内容**:
  - 予算年度パターンを `-(\d{2})年度` から `-(\d{1,2})年度-` に変更
  - 令和元年度の検出による文脈判定を追加
  - 年度番号20以上は平成、それ以下は令和/平成を文脈で判定するロジックを実装
- **結果**: 2020年度の5,445件のレコードを正常に抽出

#### データ品質レポート更新
- 2020年度データ修正に伴い、DATA_QUALITY_REPORT.mdを更新
- 総レコード数: 1,348,583件 → 1,327,926件（異常年データ削除により減少）
- 予算・執行レコード: 2020年度が含まれるようになり、全10年度のデータが揃った

## [1.0.0] - 2025-10-03

### 実装完了
- 2014-2023年度の行政事業レビューデータの完全処理
- RSシステム形式への変換パイプライン

### 主な機能

#### データ処理
- **全10年分対応**: 2014年から2023年までの行政事業レビューデータを処理
- **多様な形式対応**: Excel（1シート/2シート構成）、ZIP形式に対応
- **総レコード数**: 1,348,583件を処理

#### テーブル構造
3種類のテーブルを生成：
1. **基本情報・事業概要** (1-2): 51,557件
2. **予算・執行サマリ** (2-1): 534,477件
3. **支出先情報** (5-1): 762,549件

#### 予算事業ID統一化
- 各年度で1から始まる通し番号を採用
- 3テーブル間で完全紐付け可能
- RS_2024形式に準拠

#### データ正規化
- neologdnによる日本語テキスト正規化
- カスタム正規化ロジック（全角/半角統一、ゆらぎ吸収）
- 和暦→西暦変換（2桁年号含む、明治時代から対応）

#### 支出先データ抽出
- 2014年形式（グループ形式）対応
- 2015年以降形式（ブロック形式）対応
- 全10年分の支出先上位10者データを完全抽出

### 技術的改善

#### Stage 3: テーブル構築
- 各テーブルで全行処理（各行=1事業）に変更
- 予算事業IDの事前割り当て方式を採用
- 年度開始時にIDカウンターリセット

#### パターンマッチング改善
- 予算年度の2桁表記対応（例: `-23年度` → 平成23年度）
- 支出先フィールドのパターン修正（`-支出先` 形式に対応）
- 2014年グループ形式と2015年以降ブロック形式の両対応

### パフォーマンス
- Stage 3処理時間: 約10分（全10年度）
- メモリ効率: 大規模CSVファイルの段階的処理

### 出力
- 年度別ディレクトリ構造: `output/processed/year_YYYY/`
- CSVファイル命名規則: `{table_id}_{year}_{table_name}.csv`
- スキーマ定義: JSON形式で各テーブルの構造を出力
