# 長音記号（ー）のハイフン（-）変換調査レポート

**調査日時**: 2025年10月20日
**調査対象**: パイプライン処理における長音記号の変換タイミング

## 1. 調査の背景

国会議員報酬調査レポートにおいて、「フォロ-アップ」という表記が見られました。本来は「フォローアップ」（長音記号ー）であるべきところ、ハイフン（-）に変換されています。

この変換がパイプラインのどの段階で発生しているかを特定するための調査を実施しました。

## 2. 調査方法

### 2.1 検索対象

- キーワード: 「フォロ」（フォローの一部）
- 対象ファイル: 2014年度のデータ（海洋資源調査事業に記載あり）

### 2.2 調査段階

1. **元データ (data/download/)**: Excel形式（バイナリのため直接確認不可）
2. **Stage 1 出力 (output/raw/)**: CSV変換後のデータ
3. **Stage 2 出力 (output/normalized/)**: 正規化後のデータ
4. **Stage 3 出力 (output/processed/)**: テーブル分割後のデータ

## 3. 調査結果

### 3.1 各段階での文字確認

| 段階 | ディレクトリ | 表記 | バイトコード |
|------|-------------|------|-------------|
| **Stage 1 出力** | `output/raw/year_2014/` | `フォロー` | `e3 83 bc` (U+30FC) |
| **Stage 2 出力** | `output/normalized/year_2014/` | `フォロ-` | `2d` (U+002D) |
| **Stage 3 出力** | `output/processed/year_2014/` | `フォロ-` | `2d` (U+002D) |

### 3.2 変換タイミングの特定

**結論**: 長音記号（ー）からハイフン（-）への変換は、**Stage 2: Normalize（正規化）**の段階で発生しています。

### 3.3 実際のコマンド結果

```bash
# Stage 1 (raw)
$ grep -o "フォロ." output/raw/year_2014/2014_データベース.csv | head -1
フォロー

$ echo "フォロー" | xxd
00000000: e383 95e3 82a9 e383 ade3 83bc 0a         .............
                                ↑ U+30FC（長音記号ー）

# Stage 2 (normalized)
$ grep -o "フォロ." output/normalized/year_2014/2014_データベース.csv | head -1
フォロ-

$ echo "フォロ-" | xxd
00000000: e383 95e3 82a9 e383 ad2d 0a              .........-.
                                ↑ U+002D（ハイフンマイナス-）
```

## 4. 原因の特定

### 4.1 該当コード

**ファイル**: `src/utils/normalization.py`

**該当箇所**: 46-50行目

```python
# ハイフン・ダッシュの統一
HYPHEN_CHARS = [
    '‐', '‑', '‒', '–', '—', '―', '−', 'ー',  # 各種ハイフン・ダッシュ
    '─', '━', '～', '〜',  # 罫線、波ダッシュ
]
```

**処理関数**: 140-152行目

```python
def normalize_hyphens(text: str) -> str:
    """
    各種ハイフン・ダッシュ記号を標準的な「-」（ハイフンマイナス）に統一

    Args:
        text: 変換対象のテキスト

    Returns:
        変換後のテキスト
    """
    for char in HYPHEN_CHARS:
        text = text.replace(char, '-')
    return text
```

### 4.2 処理フロー

**メイン関数**: `normalize_text()` (171-222行目)

処理順序:
1. 丸数字の変換（①→1）
2. neologdnによる正規化（オプション）
3. Unicode NFKC正規化
4. 和暦→西暦変換
5. **ハイフン・ダッシュの統一** ← ここで長音記号（ー）が変換される
6. カタカナ長音記号の誤用修正
7. 連続空白の削除

## 5. 設計意図の分析

### 5.1 長音記号（ー）をハイフン統一対象に含めた理由（推測）

1. **データの揺れ対策**
   - カタカナの長音記号（ー）とハイフン（-）が混在しているデータを統一
   - 例: 「サ−ビス」（マイナス記号）と「サービス」（長音記号）

2. **検索・照合の容易性**
   - 記号の種類が減ることで、テキスト検索が容易になる
   - データベースのユニーク性判定が簡単になる

3. **CSV処理の安定性**
   - 特殊文字を減らすことでエンコーディングエラーのリスク低減

### 5.2 副作用

- **カタカナの長音が正しく表現されない**
  - 「フォローアップ」→「フォロ-アップ」
  - 「サーバー」→「サ-バ-」
  - 「コンピューター」→「コンピュ-タ-」

- **可読性の低下**
  - 人間が読む際に違和感がある
  - 正式な文書としての品質が下がる

## 6. 影響範囲

### 6.1 影響を受けるデータ

- **output/normalized/** 以降のすべてのデータ
- **output/processed/** のすべての出力ファイル
- **data_quality/reports/** で生成されるすべてのレポート

### 6.2 影響を受けないデータ

- **data/download/** の元データ（Excel）
- **output/raw/** の Stage 1 出力（CSV変換直後）

## 7. 対応方針（今回は修正不要）

調査依頼者からの指示により、今回は**修正不要**です。

### 7.1 もし修正する場合の選択肢

#### オプション1: 長音記号を統一対象から除外

```python
# src/utils/normalization.py の 48行目を修正
HYPHEN_CHARS = [
    '‐', '‑', '‒', '–', '—', '―', '−',  # 各種ハイフン・ダッシュ（ーを除外）
    '─', '━', '～', '〜',  # 罫線、波ダッシュ
]
```

**メリット**:
- カタカナ語の可読性が向上
- 元データの表記に忠実

**デメリット**:
- ハイフンと長音記号の混在が残る
- データの揺れが増える可能性

#### オプション2: カタカナ文脈のみ長音記号を保持

```python
def normalize_hyphens_smart(text: str) -> str:
    """
    カタカナの文脈では長音記号を保持、それ以外はハイフンに統一
    """
    # カタカナの後の長音記号は保持
    # それ以外のハイフン類は統一
    # （実装例は省略）
```

**メリット**:
- 文脈に応じた最適な処理
- データの整合性と可読性の両立

**デメリット**:
- 実装が複雑
- 処理速度が低下

#### オプション3: 後処理で復元

```python
# Stage 3 または レポート生成時に長音記号を復元
known_katakana_words = {
    'フォロ-': 'フォロー',
    'サ-バ-': 'サーバー',
    'コンピュ-タ-': 'コンピューター',
}
```

**メリット**:
- 既存の正規化ロジックを維持
- 表示のみ改善

**デメリット**:
- 辞書のメンテナンスが必要
- すべてのカタカナ語に対応できない

## 8. neologdnとの関係

### 8.1 重要な発見

**neologdnライブラリは長音記号（ー）をハイフン（-）に変換しません。**

実際の動作確認結果:

```python
import neologdn

text = "フォローアップ"
result = neologdn.normalize(text)
print(result)  # → "フォローアップ"（長音記号が保持される）
```

### 8.2 処理フローの詳細

| ステップ | 処理内容 | 入力 | 出力 | 長音記号 |
|---------|---------|------|------|---------|
| 1 | neologdn.normalize() | フォローアップ | フォローアップ | ✓ 保持 |
| 2 | NFKC正規化 | フォローアップ | フォローアップ | ✓ 保持 |
| 3 | **normalize_hyphens()** | フォローアップ | フォロ-アップ | ✗ 変換 |

### 8.3 結論

長音記号（ー）からハイフン（-）への変換は：

- ❌ **neologdnライブラリの機能ではない**
- ✅ **私たちのコード（normalization.py）で独自に実装した処理**

neologdnの公式リポジトリ（https://github.com/ikegami-yukino/neologdn）には、長音記号をハイフンに変換する根拠や言及は**ありません**。

### 8.4 実装の経緯

- **最初のコミット**: `2e5d66e feat: 行政事業レビューデータ処理パイプライン完成 (2014-2023年度)`
- **実装箇所**: `src/utils/normalization.py:48` の `HYPHEN_CHARS` リストに長音記号（ー）を含めた
- **設計判断**: プロジェクト固有の要件として、ハイフン類を統一する際に長音記号も対象に含めた

### 8.5 neologdnの実際の役割

neologdnは以下の正規化を行います（長音記号の変換は含まない）：

- 半角カタカナ → 全角カタカナ
- 全角英数字 → 半角英数字
- 連続した長音記号の正規化（「サーーー」→「サー」）
- 濁点・半濁点の結合
- 不要な空白の削除

参考: neologdn公式ドキュメント
- GitHub: https://github.com/ikegami-yukino/neologdn
- PyPI: https://pypi.org/project/neologdn/

## 9. まとめ

### 9.1 調査結果

- **変換タイミング**: Stage 2: Normalize（正規化）
- **変換場所**: `src/utils/normalization.py:normalize_hyphens()`
- **変換内容**: U+30FC（ー）→ U+002D（-）

### 9.2 neologdnとの関係

**重要**: 長音→ハイフン変換は**neologdnライブラリの機能ではありません**。
私たちのコード（normalization.py）で独自に実装した処理です。

### 9.3 確認方法

```bash
# raw と normalized を比較
grep -o "フォロ." output/raw/year_2014/2014_データベース.csv | head -1
# → フォロー

grep -o "フォロ." output/normalized/year_2014/2014_データベース.csv | head -1
# → フォロ-
```

### 9.4 今後の参考

この調査により、パイプライン内のテキスト正規化の動作が明確になりました。将来的に正規化ルールを見直す際の参考資料として活用できます。

---

**調査完了**
