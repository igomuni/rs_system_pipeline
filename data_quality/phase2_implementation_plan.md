# Phase 2: 新規ファイルタイプ作成 実装計画

生成日時: 2025-10-07
最終更新: 2025-10-07

## ✅ 実装完了サマリ

**進捗**: 9/12 ファイル完了（75%）

| ステータス | ファイル数 | ファイル | 備考 |
|-----------|-----------|---------|------|
| ✅ **完了** | 9 | 6-1, 1-1, 1-4, 1-3, 2-2, 4-1, 1-5, 5-3, 5-4 | 実装済み |
| ❌ **実装不可** | 1 | 5-2 | 元データに情報無し |
| ⏭️ **スキップ** | 2 | 3-1, 3-2 | 複雑性vs価値判断 |

---

## 実装済みファイル詳細

### ✅ 高優先度（4/4完了）
1. **6-1_その他備考** (14列) - 備考フィールド抽出
2. **1-1_組織情報** (22列) - 組織階層構造化
3. **1-4_補助率等** (18列) - テキストパース
4. **1-3_政策・施策、法令等** (28列) - 政策体系情報

### ✅ 中優先度（3/3完了）
5. **4-1_点検・評価** (37列) - 評価結果
6. **1-5_関連事業** (17列) - 事業関連情報
7. **5-3_費目・使途** (20列) - 費目詳細

### ✅ 低優先度（1/3完了）
8. **2-2_予算種別・歳出予算項目** (26列) - 予算種別展開

### ✅ 保留ファイル（1/2完了）
9. **5-4_国庫債務負担行為等による契約** (27列) - 複数年度契約

---

## 旧サマリ（参考）

| 優先度 | ファイル数 | ファイル | 理由 |
|--------|-----------|---------|------|
| **高** | 4 | 1-1, 1-3, 1-4, 6-1 | データ存在確認済み、構造シンプル |
| **中** | 3 | 1-5, 4-1, 5-3 | データ存在確認済み、やや複雑 |
| **低** | 3 | 3-1, 3-2, 2-2 | データ存在するが構造変換が複雑 |
| **保留** | 2 | 5-2, 5-4 | データ構造要調査 |

---

## 高優先度（即座に実装可能）

### 1-1_組織情報 (22列)

**RS System 2024 列定義**:
1. シート種別
2. 事業年度
3. 予算事業ID
4. 事業名
5. 建制順
6. 所管府省庁
7. 府省庁
8. 局・庁
9. 部
10. 課
11. 室
12. 班
13. 係
14. その他担当組織_作成責任者_no
15. 府省庁（その他担当組織）
16. 局・庁（その他担当組織）
17. 部（その他担当組織）
18. 課（その他担当組織）
19. 室（その他担当組織）
20. 班（その他担当組織）
21. 係（その他担当組織）
22. 作成責任者

**2023年ソースデータ**:
- ✅ `作成責任者` - 存在確認済み
- ❓ その他担当組織系 - ソースデータで列名確認が必要

**実装方針**:
- 基本組織情報（1-13列）は既存ロジック流用
- `作成責任者`列を抽出
- その他担当組織は2023データに存在するか確認後、あれば抽出

**複雑度**: ★☆☆☆☆ (低)

---

### 1-3_政策・施策、法令等 (28列)

**RS System 2024 列定義**:
1-13. 基本情報（共通）
14. 番号（政策・施策）
15. 政策所管府省庁_P
16. 政策
17. 施策
18. 政策・施策URL
19. 番号（根拠法令）
20. 法令名
21. 法令番号
22. 法令ID
23. 条
24. 項
25. 号・号の細分
26. 番号（関係する計画・通知等）
27. 計画通知名
28. 計画通知等URL

**2023年ソースデータ**:
- ✅ `政策` - 存在確認済み
- ✅ `施策` - 存在確認済み
- ✅ `政策体系・評価書URL` - 存在確認済み
- ✅ `根拠法令（具体的な条項も記載）` - 存在確認済み

**実装方針**:
1. 政策・施策セクション:
   - `政策`、`施策`を抽出
   - `政策体系・評価書URL` → `政策・施策URL`
   - 番号は連番生成（1事業内で複数政策がある場合）

2. 根拠法令セクション:
   - `根拠法令（具体的な条項も記載）`をパース
   - テキストから法令名、条項を抽出（正規表現）
   - 番号は連番生成

3. 計画・通知セクション:
   - 2023データに該当列があるか確認必要

**複雑度**: ★★★☆☆ (中) - テキストパース必要

---

### 1-4_補助率等 (18列)

**RS System 2024 列定義**:
1-13. 基本情報（共通）
14. 番号（補助率等）
15. 補助対象
16. 補助率
17. 補助上限等
18. 補助率URL

**2023年ソースデータ**:
- ✅ `補助率等` - 存在確認済み

**実装方針**:
- `補助率等`列をパースして構造化
- テキスト例: "補助率: 1/2、対象: 地方公共団体、上限: 1億円"
- 正規表現でパースして各フィールドに分割
- 複数ある場合は番号で分割（セミコロン区切りなど）

**複雑度**: ★★☆☆☆ (中低) - テキストパース必要だが構造シンプル

---

### 6-1_その他備考 (14列)

**RS System 2024 列定義**:
1-13. 基本情報（共通）
14. その他備考

**2023年ソースデータ**:
- 2023データに`備考`や`その他`系の列があるか確認必要

**実装方針**:
- 該当列を抽出してマッピング
- 最もシンプルなファイル

**複雑度**: ★☆☆☆☆ (低)

---

## 中優先度（やや複雑）

### 1-5_関連事業 (17列)

**RS System 2024 列定義**:
1-13. 基本情報（共通）
14. 番号（関連事業）
15. 関連事業の事業ID
16. 関連事業の事業名
17. 関連性

**2023年ソースデータ**:
- ✅ `関連する過去のレビューシートの事業番号-YYYY年度-NN` - 存在確認済み
- 多数の年度×番号の組み合わせで列が存在（2010-2022年度、各年度01-04）

**実装方針**:
1. 関連事業番号列を動的検出（正規表現: `関連する過去のレビューシートの事業番号-(\d{4})年度-(\d{2})`）
2. 値が存在する列のみ抽出
3. 各関連事業ごとに1行作成（行を複数生成）
4. 番号は連番
5. 関連性は「過去事業」などデフォルト値

**複雑度**: ★★★☆☆ (中) - 1事業→複数行の変換必要

---

### 4-1_点検・評価 (37列)

**RS System 2024 列定義** (一部):
14. 事業所管部局による点検・改善ー点検結果
15. 事業所管部局による点検・改善ー改善の方向性
16. 事業所管部局による点検・改善－目標年度における効果測定に関する評価
17. 外部有識者による点検ー最終実施年度
18. 外部有識者による点検ー点検対象
19. 外部有識者による点検ー対象の理由
20. 外部有識者による点検ー所見
21. 公開プロセス結果概要
22. 行政事業レビュー推進チームの所見
...

**2023年ソースデータ**:
- ✅ `事業所管部局による点検・改善-点検結果`
- ✅ `事業所管部局による点検・改善-改善の方向性`
- ✅ `事業所管部局による点検・改善-目標年度における効果測定に関する評価`
- ✅ `外部有識者の所見--`
- ✅ `行政事業レビュー推進チームの所見に至る過程及び所見-判定`
- ✅ `行政事業レビュー推進チームの所見に至る過程及び所見-初見`
- ✅ `過去に受けた指摘事項と対応状況-公開プロセス・秋の年次公開検証（秋のレビュー）における取りまとめ`

**実装方針**:
- 列名マッピングを作成
- 2023の列名 → RS 2024列名
- ほぼ1対1マッピングで実装可能
- 列数が多いが構造はシンプル

**複雑度**: ★★☆☆☆ (中低) - 列数多いが単純マッピング

---

### 5-3_費目・使途 (20列)

**RS System 2024 列定義**:
1-13. 基本情報（共通）
14. 番号（費目・使途）
15. 費目・使途
16. 金額
17-20. その他詳細情報

**2023年ソースデータ**:
- 確認必要（費目、使途関連の列）

**実装方針**:
- ソースデータ調査後に決定

**複雑度**: ★★★☆☆ (中) - データ構造要確認

---

## 低優先度（構造変換が複雑）

### 3-1_効果発現経路_目標・実績 (82列)

**RS System 2024 列定義** (一部):
14. 事業に関連するKPIが定められている閣議決定等の名称
15. 事業に関連するKPIが定められている閣議決定等の該当箇所
16. 事業に関連するKPIが定められている閣議決定等のURL
17. アクティビティ・アウトプット・アウトカムの番号
18. 種別（アクティビティ・アウトプット・アウトカム）
19. アウトカムの期間
20. 成果目標の種類
21. アクティビティ／活動目標／成果目標
22. 活動指標／成果指標
23. 単位
24. 改善の上向き／下向き
25. 成果実績及び目標値の根拠として用いた統計・データ名（出典）
...
29-82. 年度別目標値・実績値（2007-2060年度）

**2023年ソースデータ**:
- ✅ `事業に関連する ＫＰＩが定められている閣議決定等-名称`
- ✅ `事業に関連する ＫＰＩが定められている閣議決定等-該当箇所`
- ✅ `事業に関連する ＫＰＩが定められている閣議決定等-URL`
- ✅ `活動内容①（アクティビティ）-NN`
- ✅ `活動目標及び活動実績①（アウトプット）-活動目標-NN`
- ✅ `活動目標及び活動実績①（アウトプット）-活動指標-NN`
- ✅ 年度別データ（2020-2024年度）

**実装方針**:
1. 2023データは複数セット（①、②、③...）として横展開されている
2. RS 2024は縦展開（1アクティビティ=1行）
3. データ構造の大幅な変換が必要:
   - 横持ち → 縦持ち変換
   - アクティビティ/アウトプット/アウトカムの分離
   - 番号付与
4. 年度列のピボット処理

**複雑度**: ★★★★★ (高) - 複雑なデータ構造変換

---

### 3-2_効果発現経路_目標のつながり (23列)

**実装方針**:
- 3-1のアクティビティ/アウトプット/アウトカムの関連性を表現
- 3-1実装後に着手

**複雑度**: ★★★★☆ (高) - 3-1に依存

---

### 2-2_予算種別・歳出予算項目 (26列)

**実装方針**:
- 予算の詳細分類情報
- 2023データで該当列を調査後に決定

**複雑度**: ★★★☆☆ (中) - データ構造要確認

---

## 保留（データ構造要調査）

### 5-2_支出ブロックのつながり (22列)

**実装方針**:
- 支出先ブロック間の関連性
- 5-1の拡張として実装
- 2023データで該当情報があるか要調査

**複雑度**: ★★★★☆ (高) - データ存在不明

---

### 5-4_国庫債務負担行為等による契約 (27列)

**実装方針**:
- 複数年度契約情報
- 2023データで該当列を調査

**複雑度**: ★★★☆☆ (中) - データ構造要確認

---

## 推奨実装順序

### Step 1: 高優先度ファイル（1-2週間）
1. **6-1_その他備考** - ウォーミングアップ、最もシンプル
2. **1-1_組織情報** - 組織情報の構造化
3. **1-4_補助率等** - テキストパース練習
4. **1-3_政策・施策、法令等** - テキストパース応用

### Step 2: 中優先度ファイル（1-2週間）
5. **4-1_点検・評価** - 列数多いが単純マッピング
6. **1-5_関連事業** - 1対多変換の実装
7. **5-3_費目・使途** - データ構造確認後

### Step 3: 低優先度ファイル（2-3週間）
8. **2-2_予算種別・歳出予算項目** - 予算詳細
9. **3-1_効果発現経路_目標・実績** - 最も複雑
10. **3-2_効果発現経路_目標のつながり** - 3-1に依存

### Step 4: 保留ファイル（要調査）
11. **5-2_支出ブロックのつながり**
12. **5-4_国庫債務負担行為等による契約**

---

## 技術的課題

### 共通課題
1. **行の複製**: 1事業で複数の関連情報がある場合（1-5, 3-1など）
2. **テキストパース**: 自由記述を構造化（1-3, 1-4）
3. **列名の動的検出**: 年度別・番号別に展開された列の検出

### ファイル固有課題
- **3-1**: 横持ち→縦持ち変換 + 年度ピボット
- **1-5**: 関連事業番号の動的検出と行展開
- **1-3**: 法令テキストの正規表現パース

---

## ❌ 実装不可・スキップファイル詳細

### ❌ 5-2_支出ブロックのつながり（実装不可）

**理由**: 元データに複数支出ブロック間の関連情報が存在しない

**調査結果**:
- 2014-2023年のレビューシートには「A.支払先」ブロックのみ存在
- 複数ブロック間の資金フロー・関連性を示すデータ無し
- RS System 2024で新設された概念と推測

**結論**: データ不足により実装不可

---

### ⏭️ 3-1_効果発現経路_目標・実績（スキップ）

**理由**: 82列の複雑な構造で実用性が低い

**複雑性**:
- 横持ち→縦持ち変換が必要
- アクティビティ/アウトプット/アウトカムの3層構造
- 年度列のピボット処理
- データ構造の大幅な変換

**判断**: コストvs価値で実装見送り

---

### ⏭️ 3-2_効果発現経路_目標のつながり（スキップ）

**理由**: 3-1に依存、3-1未実装のため実装不可

---

## 完了: 次のアクション（参考）

1. ✅ **Step 1完了**: 高優先度4ファイル実装済み
2. ✅ **Step 2完了**: 中優先度3ファイル実装済み
3. ✅ **Step 3完了**: 低優先度1ファイル実装済み
4. ✅ **Step 4完了**: 保留1ファイル実装済み

**実装箇所**: `src/pipeline/table_builder.py` (lines 654-1652)
