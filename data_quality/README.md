# データ品質確認ツール

処理済みデータの品質を確認・レポート生成するためのツール群

## ディレクトリ構成

```
data_quality/
├── README.md                      # このファイル
├── generate_quality_report.py    # 年度別品質レポート生成（メインツール）
├── check_totals.py               # 年度別予算・執行額の簡易チェック
├── summary_report.py             # 予算・執行額サマリーレポート
├── expenditure_summary.py        # 支出先データサマリーレポート
└── reports/                      # 生成されたレポート保存先
    ├── quality_report_2014.md
    ├── quality_report_2015.md
    └── ...
```

## 使用方法

### 1. 年度別品質レポート生成（推奨）

全年度の詳細な品質レポートを一括生成します。

```bash
python data_quality/generate_quality_report.py
```

**出力**:
- `data_quality/DATA_QUALITY_REPORT.md`: **全年度統合レポート**
  - 年度別基本統計一覧
  - 予算・執行データ一覧
  - 支出先データ一覧
  - 検出された品質問題一覧（事業名・府省庁付き）
  - 推奨事項
- `data_quality/reports/quality_report_YYYY.md`: 各年度の詳細レポート
  - 基本情報（事業数、ファイルサイズ）
  - 予算・執行データの統計
  - 支出先データの統計
  - 検出された品質問題

**品質チェック項目**:
- ✅ 予算合計の異常値検出（100兆円以上）
- ✅ 単一事業の予算異常値検出（1兆円以上）
- ✅ 支出額合計の異常値検出（50兆円以上）
- ✅ 平均支出額の異常値検出（100億円以上）

### 2. 予算・執行額サマリー

10年分の予算・執行額を一覧表示します。

```bash
python data_quality/summary_report.py
```

**出力例**:
```
年度       事業数                  当初予算(10億円)            執行額(10億円)          執行率(%)
----------------------------------------------------------------------------------------------------
2014     4,739               1,784,582.6          2,313,790.5          129.7% ⚠️ 異常値
2015     5,365                  34,526.1             35,399.3          102.5%
...
```

### 3. 支出先データサマリー

10年分の支出先データを一覧表示します。

```bash
python data_quality/expenditure_summary.py
```

**出力例**:
```
年度              支出先件数            支出額合計(10億円)             平均支出額(百万円)
------------------------------------------------------------------------------------------------------------------------
2014           67,436          18,198,445.62           2,698,624.71 ⚠️ 異常値
2015           71,544              15,637.41               2,185.70
...
```

### 4. 簡易チェック

年度別の予算総額と執行額を簡易表示します（デバッグ用）。

```bash
python data_quality/check_totals.py
```

## レポート解説

### 生成される品質レポートの見方

#### 基本情報
- **総事業数**: その年度の事業数
- **ファイルサイズ**: 基本情報ファイルのサイズ（処理効率の目安）

#### 予算・執行データ
- **当初予算合計**: 全事業の当初予算の合計（10億円単位）
- **執行率**: 執行額 ÷ 当初予算 × 100
  - 正常値: 100-110%程度
  - 高値の要因: 補正予算、繰越予算
- **予算最大値/最小値**: 異常値検出の参考

#### 支出先データ
- **支出先件数**: 支出先の総件数
- **支出額合計**: 全支出先への支出額合計（10億円単位）
- **平均支出額**: 1件あたりの平均支出額（百万円単位）
  - 正常値: 1,000-2,000百万円程度

#### 品質問題の重大度

- **高**: データの信頼性に重大な影響（単位間違いなど）
- **中**: 注意が必要だが、一部データのみに影響
- **低**: 軽微な問題

## 既知の品質問題

### 2014年度
- **予算データ**: 一部事業で100万倍の単位間違い
- **支出データ**: 約18,000兆円（正常値の約1,800倍）
- **原因**: 百万円単位のところに円単位で入力
- **影響事業**: 約10事業（文部科学省の原子力関連事業）

### 2016年度
- **支出データ**: 約115兆円（正常値の約11倍）
- **原因**: 調査中
- **影響事業**: 特定が必要

### 2020年度
- **予算データ**: ~~データ欠損~~（✅ 修正済）
- **修正内容**: 正規表現パターンを修正し、5,445件のレコードを抽出

## 開発者向け情報

### 新しいチェック項目の追加

`generate_quality_report.py`の`generate_year_report()`関数に追加:

```python
# 例：執行率が200%を超える場合
if report['budget']['執行率(%)'] > 200:
    report['quality_issues'].append({
        'カテゴリ': '予算',
        '重大度': '中',
        '問題': f'執行率が異常に高い ({report["budget"]["執行率(%)"]}%)'
    })
```

### レポート形式のカスタマイズ

`save_year_report_md()`関数を編集してMarkdown出力をカスタマイズできます。

## 注意事項

- レポート生成には`output/processed/`に処理済みデータが必要です
- 生成されたレポートは`data_quality/reports/`に保存されます
- 既存のレポートは上書きされます
- 金額単位:
  - 10億円 = 0.01兆円
  - 1兆円 = 1,000 × 10億円
  - 百万円 = 0.001 × 10億円

## 関連ドキュメント

- [DATA_QUALITY_REPORT.md](DATA_QUALITY_REPORT.md): 全年度統合品質レポート（自動生成）
- [CHANGELOG.md](../CHANGELOG.md): 修正履歴

## レポート例

### 統合レポート（DATA_QUALITY_REPORT.md）

全年度のデータを一覧化した統合レポートです：

- **年度別基本統計**: 事業数、レコード数、ファイルサイズを一覧表示
- **予算・執行データサマリー**: 予算・執行額を10年分比較
- **支出先データサマリー**: 支出先件数と支出額を10年分比較
- **品質問題一覧**: 検出された全問題を重大度順に表示（事業名・府省庁を含む）
- **推奨事項**: 緊急対応が必要な年度と長期的改善項目

### 年度別レポート（reports/quality_report_YYYY.md）

各年度の詳細な統計情報と品質問題を記載：

- 基本情報: 総事業数、ファイルサイズ
- 予算・執行データ: 合計、執行率、最大値/最小値
- 支出先データ: 件数、合計、平均、最大値/最小値
- 品質問題: その年度で検出された具体的な問題
