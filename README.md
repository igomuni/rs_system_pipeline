# RS System Pipeline

行政事業レビューの過去データ（2014-2023年度）をRSシステム形式のCSVに変換するパイプライン

## 概要

このプロジェクトは、[行政事業レビュー](https://www.gyoukaku.go.jp/review/database/index.html)で公開されている過去のExcel/ZIPファイルを、[RSシステム](https://rssystem.go.jp/)と同様の複数のCSVファイルに分割・正規化するパイプラインです。

2014年から2023年までの10年分のデータを処理し、3種類のテーブル（基本情報・事業概要、予算・執行サマリ、支出先情報）に分割して出力します。

## 特徴

- **10年分のデータ対応**: 2014-2023年度の行政事業レビューデータを処理
- **多様なデータ形式に対応**: Excel（1シート/2シート構成）、ZIP形式
- **日本語テキスト正規化**: neologdn、カスタム正規化ロジック
- **和暦・西暦変換**: 明治時代からの和暦に対応（2桁年号も対応）
- **RSシステム互換**: 出力形式をRSシステムのCSVに準拠
- **統一された予算事業ID**: 各年度で1から始まる通し番号、3テーブル間で完全紐付け
- **パイプライン処理**: Stage-based architecture

## プロジェクト構造

```
rs_system_pipeline/
├── data/
│   └── download/         # 元データ配置場所（Excel/ZIP）
├── output/
│   ├── raw/             # Stage1: Excel→CSV変換後
│   ├── normalized/      # Stage2: 正規化後
│   ├── processed/       # Stage3+: 最終処理済みデータ
│   └── schema/          # スキーマ定義
├── src/
│   ├── pipeline/        # パイプライン処理
│   └── utils/           # ユーティリティ
├── data_quality/        # データ品質確認ツール
│   ├── generate_quality_report.py  # 年度別品質レポート生成
│   ├── summary_report.py           # 予算・執行額サマリー
│   ├── expenditure_summary.py      # 支出先データサマリー
│   └── reports/                    # 生成されたレポート
├── scripts/             # ユーティリティスクリプト
├── tests/               # テストコード
├── config.py            # 設定ファイル
└── main.py              # エントリーポイント
```

## 必要な環境

- Python 3.9+
- 依存ライブラリ: requirements.txt参照

## インストール

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. データの配置

`data/download/` に過去データのExcel/ZIPファイルを配置

### 2. パイプライン実行

```bash
python main.py
```

### 3. 出力結果

`output/processed/` に年度別・カテゴリ別のCSVファイルが生成されます

## パイプラインステージ

1. **Stage 1**: Excel/ZIP → CSV変換
   - 複数のExcel形式（1シート、2シート構成）に対応
   - ZIP内の複数ファイル処理

2. **Stage 2**: テキスト正規化
   - neologdnによる日本語テキスト正規化
   - カスタム正規化ロジック（全角/半角統一、ゆらぎ吸収）
   - 和暦→西暦変換（2桁年号含む）

3. **Stage 3**: RSシステム形式へのテーブル分割
   - **1-2_基本情報_事業概要.csv**: 各事業の基本情報（年度ごと約5,000件）
   - **2-1_予算・執行_サマリ.csv**: 予算・執行額の年度別データ
   - **5-1_支出先_支出情報.csv**: 支出先上位10者の詳細情報
   - 予算事業IDによる3テーブル間の完全紐付け

4. **Stage 4**: スキーマ定義の生成
   - 各テーブルのカラム定義をJSON形式で出力

## 出力データ統計（2014-2023年度）

**空データフィルタ適用済** (v1.0.3): 予算レコードから実データのない年度を除外し、ファイルサイズを約70%削減

- **総レコード数**: 1,001,980件
- **総ファイル数**: 30ファイル（年度 × 3種類）
- **事業概要テーブル**: 52,557件（全年度合計）
- **予算・執行テーブル**: 188,474件（空データ除外後）
- **支出先テーブル**: 760,949件

### 年度別データ量

| 年度 | 事業数 | 予算レコード | 支出レコード |
|------|--------|--------------|--------------|
| 2014 | 4,739  | 23,695       | 67,436       |
| 2015 | 5,365  | 16,793       | 71,544       |
| 2016 | 5,221  | 16,654       | 74,510       |
| 2017 | 5,166  | 16,439       | 74,296       |
| 2018 | 5,148  | 16,505       | 75,980       |
| 2019 | 5,198  | 16,622       | 78,271       |
| 2020 | 5,445  | 17,046       | 80,160       |
| 2021 | 5,440  | 21,846       | 79,598       |
| 2022 | 5,394  | 21,487       | 78,994       |
| 2023 | 5,441  | 21,387       | 80,160       |

**注**: 予算レコード数は各年度ファイルに含まれる実データのある年度のみをカウント（4〜5年分）

## データ構造

### 予算事業ID

各年度で **1から始まる通し番号** を採用。3つのテーブル間で同一IDにより紐付けが可能です。

例：2023年度のID=100の場合
- 基本情報: 1件（事業の基本データ）
- 予算・執行: 15件（複数年度の予算データ）
- 支出先: 28件（支出先上位10者の詳細）

## データ品質確認

処理済みデータの品質を確認するためのツールを提供しています。

### 年度別品質レポート生成

```bash
python data_quality/generate_quality_report.py
```

全年度（2014-2023）の詳細な品質レポートを生成します。レポートには以下の情報が含まれます：
- 基本統計（事業数、ファイルサイズ）
- 予算・執行データの統計
- 支出先データの統計
- 検出された品質問題（異常値など）

生成されたレポートは `data_quality/reports/` に保存されます。

### その他のツール

- **予算・執行額サマリー**: `python data_quality/summary_report.py`
- **支出先データサマリー**: `python data_quality/expenditure_summary.py`

詳細は [data_quality/README.md](data_quality/README.md) を参照してください。

### 既知のデータ品質問題

- **2014年度**: 一部事業で単位間違い（約100万倍の異常値）
- **2016年度**: 支出先データに単位間違いの可能性

詳細は [DATA_QUALITY_REPORT.md](data_quality/DATA_QUALITY_REPORT.md) を参照してください。

## 参考プロジェクト

- [gyoukaku-pipeline](https://github.com/igomuni/gyoukaku-pipeline): 前プロジェクト
- [rs_system_schema_project](https://github.com/igomuni/rs_system_schema_project): RSシステム解析

## ライセンス

MIT
