# RS System Pipeline

行政事業レビューの過去データ（2014-2023年度）をRSシステム形式のCSVに変換するパイプライン

## 概要

このプロジェクトは、[行政事業レビュー](https://www.gyoukaku.go.jp/review/database/index.html)で公開されている過去のExcel/ZIPファイルを、[RSシステム](https://rssystem.go.jp/)と同様の複数のCSVファイルに分割・正規化するパイプラインです。

2014年から2023年までの10年分のデータを処理し、**12種類のテーブル**（基本情報、予算・執行、支出先、組織情報、政策・法令、評価、関連事業など）に分割して出力します。

## 特徴

- **10年分のデータ対応**: 2014-2023年度の行政事業レビューデータを処理
- **多様なデータ形式に対応**: Excel（1シート/2シート構成）、ZIP形式
- **日本語テキスト正規化**: neologdn、カスタム正規化ロジック
- **和暦・西暦変換**: 明治時代からの和暦に対応（2桁年号も対応）
- **RSシステム互換**: 出力形式をRSシステム2024のCSV構造に準拠（12ファイル形式）
- **統一された予算事業ID**: 各年度で1から始まる通し番号、全テーブル間で完全紐付け
- **パイプライン処理**: Stage-based architecture
- **API/CLIモード**: FastAPIによるWebサービスまたはCLIツールとして実行可能

## プロジェクト構造

```
rs_system_pipeline/
├── data/
│   └── download/         # 元データ配置場所（Excel/ZIP）
├── output/
│   ├── raw/             # Stage1: Excel→CSV変換後
│   ├── normalized/      # Stage2: 正規化後
│   ├── processed/       # Stage3+: 最終処理済みデータ
│   └── schema/          # スキーマ定義
├── src/
│   ├── pipeline/        # パイプライン処理
│   └── utils/           # ユーティリティ
├── data_quality/        # データ品質確認ツール
│   ├── generate_quality_report.py  # 年度別品質レポート生成
│   ├── summary_report.py           # 予算・執行額サマリー
│   ├── expenditure_summary.py      # 支出先データサマリー
│   └── reports/                    # 生成されたレポート
├── scripts/             # ユーティリティスクリプト
├── tests/               # テストコード
├── config.py            # 設定ファイル
└── main.py              # エントリーポイント
```

## 必要な環境

- Python 3.9+
- 依存ライブラリ: requirements.txt参照

## インストール

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. データの配置

`data/download/` に過去データのExcel/ZIPファイルを配置

### 2. パイプライン実行

#### CLIモード

```bash
# 全ステージ実行（Stage 1から）
python main.py

# 特定ステージから実行
python main.py --stage 3

# ステージ指定（1: Excel変換, 2: 正規化, 3: テーブル分割, 4: スキーマ生成）
python main.py --stage [1-4]
```

#### APIサーバーモード

```bash
# APIサーバーとして起動
python main.py --server --host 0.0.0.0 --port 8000

# ブラウザで http://localhost:8000/docs にアクセスしてSwagger UIを確認
```

**主要APIエンドポイント:**
- `POST /api/pipeline/run` - パイプライン実行
- `GET /api/pipeline/status/{job_id}` - ジョブステータス確認
- `GET /api/pipeline/jobs` - 全ジョブリスト
- `POST /api/pipeline/cancel/{job_id}` - ジョブキャンセル
- `GET /api/results/{filename:path}` - 処理済みファイルダウンロード

### 3. 出力結果

`output/processed/year_YYYY/` に年度別・テーブル種別のCSVファイルが生成されます

## パイプラインステージ

1. **Stage 1**: Excel/ZIP → CSV変換
   - 複数のExcel形式（1シート、2シート構成）に対応
   - ZIP内の複数ファイル処理

2. **Stage 2**: テキスト正規化
   - neologdnによる日本語テキスト正規化
   - カスタム正規化ロジック（全角/半角統一、ゆらぎ吸収）
   - 和暦→西暦変換（2桁年号含む）
   - ハイフン→長音の誤用修正（辞書ベース、50+パターン対応）

3. **Stage 3**: RSシステム形式へのテーブル分割（**12ファイル生成**）

   **基本情報系（1-X）:**
   - **1-1_組織情報.csv**: 府省・部局・課室の組織階層情報（22列）
   - **1-2_基本情報_事業概要.csv**: 各事業の基本情報（年度ごと約5,000件）
   - **1-3_政策・施策、法令等.csv**: 政策体系・根拠法令情報（28列）
   - **1-4_補助率等.csv**: 補助率・負担割合情報（18列）
   - **1-5_関連事業.csv**: 統合・分割等の関連事業情報（17列）

   **予算・執行系（2-X）:**
   - **2-1_予算・執行_サマリ.csv**: 予算・執行額の年度別データ
   - **2-2_予算種別・歳出予算項目.csv**: 予算種別の詳細展開（26列）

   **評価系（4-X）:**
   - **4-1_点検・評価.csv**: 評価結果・改善方針（37列）

   **支出先系（5-X）:**
   - **5-1_支出先_支出情報.csv**: 支出先上位10者の詳細情報
   - **5-3_費目・使途.csv**: 費目別使途詳細（20列）
   - **5-4_国庫債務負担行為等による契約.csv**: 複数年度契約情報（27列）

   **その他（6-X）:**
   - **6-1_その他備考.csv**: 特記事項・備考情報（14列）

   ※予算事業IDによる全テーブル間の完全紐付け

4. **Stage 4**: スキーマ定義の生成
   - 各テーブルのカラム定義をJSON形式で出力

## 出力データ統計（2014-2023年度）

**現在の実装状況**: RSシステム2024形式の12ファイルを生成（Phase 2完了、75%実装）

- **総ファイル数**: 120ファイル（10年度 × 12種類）
- **主要テーブル合計レコード数**: 1,000,000件以上
  - 事業概要（1-2）: 52,557件（全年度合計）
  - 予算・執行（2-1）: 188,474件（空データ除外後）
  - 支出先（5-1）: 760,949件
  - その他9ファイル: 新規実装済み

**空データフィルタ適用済** (v1.0.3+): 予算レコードから実データのない年度を除外し、ファイルサイズを約70%削減

### 年度別データ量

| 年度 | 事業数 | 予算レコード | 支出レコード |
|------|--------|--------------|--------------|
| 2014 | 4,739  | 23,695       | 67,436       |
| 2015 | 5,365  | 16,793       | 71,544       |
| 2016 | 5,221  | 16,654       | 74,510       |
| 2017 | 5,166  | 16,439       | 74,296       |
| 2018 | 5,148  | 16,505       | 75,980       |
| 2019 | 5,198  | 16,622       | 78,271       |
| 2020 | 5,445  | 17,046       | 80,160       |
| 2021 | 5,440  | 21,846       | 79,598       |
| 2022 | 5,394  | 21,487       | 78,994       |
| 2023 | 5,441  | 21,387       | 80,160       |

**注**: 予算レコード数は各年度ファイルに含まれる実データのある年度のみをカウント（4〜5年分）

## データ構造

### 予算事業ID

各年度で **1から始まる通し番号** を採用。全12テーブル間で同一IDにより紐付けが可能です。

例：2023年度のID=100の場合
- 基本情報（1-2）: 1件（事業の基本データ）
- 組織情報（1-1）: 1件（組織階層）
- 予算・執行（2-1）: 15件（複数年度の予算データ）
- 支出先（5-1）: 28件（支出先上位10者の詳細）
- その他8ファイル: 各1件以上（事業に応じて）

### データ単位の重要な注意点

**金額データの単位が年度により異なります**:

| データソース | 年度 | 単位 | 例 |
|-------------|------|------|-----|
| 歴史的レビューデータ | 2014-2023 | **百万円** | `29` = 2,900万円 |
| RSシステム2024 | 2024+ | **円（1円）** | `29,457,000` = 約2,946万円 |

**影響**: 2014-2023年度と2024年度以降のデータを直接比較すると100万倍の差が生じます。比較前に必ず単位変換が必要です。

## データ品質確認

処理済みデータの品質を確認するためのツールを提供しています。

### 年度別品質レポート生成

```bash
python data_quality/generate_quality_report.py
```

全年度（2014-2023）の詳細な品質レポートを生成します。レポートには以下の情報が含まれます：
- 基本統計（事業数、ファイルサイズ）
- 予算・執行データの統計
- 支出先データの統計
- 検出された品質問題（異常値など）

生成されたレポートは `data_quality/reports/` に保存されます。

### その他のツール

- **予算・執行額サマリー**: `python data_quality/summary_report.py`
- **支出先データサマリー**: `python data_quality/expenditure_summary.py`

詳細は [data_quality/README.md](data_quality/README.md) を参照してください。

### 既知のデータ品質問題

- **2014年度**: 一部事業で単位間違い（約100万倍の異常値、64件）
  - 例: 電源立地地域対策交付金が7.3兆円と表示（正しくは7.3億円程度）
  - **対応方針**: 元データの値をそのまま保持、品質レポートで記録
- **2016年度**: 支出先データに単位間違いの可能性

詳細は [DATA_QUALITY_REPORT.md](data_quality/DATA_QUALITY_REPORT.md) を参照してください。

## 開発ロードマップ

### Phase 1: 既存3ファイルの拡張 ✅ **完了**
RS System 2024の列構造に合わせて、既存の1-2、2-1、5-1ファイルに追加列を実装

### Phase 2: 新規ファイル種別の作成 ✅ **完了（75%）**
12ファイル中9ファイルを新規実装:
- ✅ 1-1_組織情報（22列）
- ✅ 1-3_政策・施策、法令等（28列）
- ✅ 1-4_補助率等（18列）
- ✅ 1-5_関連事業（17列）
- ✅ 2-2_予算種別・歳出予算項目（26列）
- ✅ 4-1_点検・評価（37列）
- ✅ 5-3_費目・使途（20列）
- ✅ 5-4_国庫債務負担行為等による契約（27列）
- ✅ 6-1_その他備考（14列）

**実装見送り**: 5-2（元データなし）、3-1/3-2（複雑性vs実用性）

### Phase 3: 全年度適用 🔄 **進行中**
Phase 1/2の変換ロジックを2014-2023年度すべてに適用し、検証

詳細は [CLAUDE.md](CLAUDE.md) の「Next Tasks」セクションを参照してください。

## 参考プロジェクト

- [gyoukaku-pipeline](https://github.com/igomuni/gyoukaku-pipeline): 前プロジェクト
- [rs_system_schema_project](https://github.com/igomuni/rs_system_schema_project): RSシステム解析

## ライセンス

MIT
